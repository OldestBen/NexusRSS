#!/usr/bin/env python3
import os
import sys
import subprocess
import time
import logging
import sqlite3
import threading
import json
import re
import shutil
import hashlib
import random
import xml.etree.ElementTree as ET
from io import BytesIO
from datetime import datetime, timedelta
from urllib.parse import urlparse

# --- Configuration ---
if getattr(sys, 'frozen', False):
    BASE_DIR = os.path.dirname(sys.executable)
elif globals().get('__file__') and os.path.exists(__file__):
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
else:
    BASE_DIR = os.getcwd()

DB_FILE = os.path.join(BASE_DIR, 'nexus.db')
LOG_FILE = os.path.join(BASE_DIR, 'nexus.log')
VENV_DIR = os.path.join(BASE_DIR, 'venv')
SERVICE_NAME = "nexus-feed"
SECRET_KEY = os.urandom(32).hex()
PORT = 5000

REQUIRED_PACKAGES = ["flask", "apscheduler", "requests", "feedparser", "beautifulsoup4", "lxml"]

# --- Installer / Environment Logic ---
def run_step(desc, cmd, env=None, ignore_error=False):
    sys.stdout.write(f" -> {desc}...")
    sys.stdout.flush()
    try:
        run_env = os.environ.copy()
        if env: run_env.update(env)
        subprocess.run(cmd, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, env=run_env)
        print(" Done.")
        return True
    except Exception as e:
        print(" Failed.")
        if not ignore_error:
            print(f"Error: {e}")
            sys.exit(1)
        return False

def ensure_venv():
    venv_python = os.path.join(VENV_DIR, 'bin', 'python')
    if os.path.exists(venv_python):
        if sys.prefix != VENV_DIR:
            try:
                os.execv(venv_python, [venv_python] + sys.argv)
            except OSError: pass

def setup_system():
    if os.geteuid() != 0:
        print("âŒ Run as root to install.")
        sys.exit(1)
    
    print(f"ðŸ“¡ Nexus Feed Installer")
    run_step("System Update", ['apt-get', 'update', '-qq'], env={'DEBIAN_FRONTEND': 'noninteractive'}, ignore_error=True)
    run_step("Dependencies", ['apt-get', 'install', '-y', 'python3-venv', 'python3-pip'], env={'DEBIAN_FRONTEND': 'noninteractive'})
    
    if not os.path.exists(VENV_DIR):
        run_step("Creating Venv", [sys.executable, '-m', 'venv', VENV_DIR])
    
    pip_bin = os.path.join(VENV_DIR, 'bin', 'pip')
    run_step("Installing Libs", [pip_bin, 'install'] + REQUIRED_PACKAGES + ['-q'])

    service_txt = f"""[Unit]
Description=Nexus Feed Reader
After=network.target

[Service]
User={os.environ.get('SUDO_USER', 'root')}
WorkingDirectory={BASE_DIR}
ExecStart={os.path.join(VENV_DIR, 'bin', 'python')} {os.path.abspath(__file__)}
Restart=always

[Install]
WantedBy=multi-user.target
"""
    with open(f"/etc/systemd/system/{SERVICE_NAME}.service", 'w') as f:
        f.write(service_txt)
    
    run_step("Reloading Daemon", ['systemctl', 'daemon-reload'])
    run_step("Enabling Service", ['systemctl', 'enable', SERVICE_NAME])
    run_step("Restarting Service", ['systemctl', 'restart', SERVICE_NAME])
    
    ip = subprocess.check_output("hostname -I | cut -d' ' -f1", shell=True).decode().strip()
    print(f"\nâœ… Installed. Web UI: http://{ip}:{PORT}")
    sys.exit(0)

def uninstall_system():
    if os.geteuid() != 0:
        print("âŒ Run as root to uninstall.")
        sys.exit(1)

    print(f"ðŸ”¥ Nexus Feed - Scorched Earth Uninstaller")
    print(f"âš ï¸  WARNING: This will DELETE the database, logs, service, and this script.")
    print(f"    Type 'DESTROY' to confirm.")
    if input("    Confirmation: ") != "DESTROY":
        print("âŒ Aborted.")
        sys.exit(1)

    targets = {'services': [SERVICE_NAME, 'rss-bridge'], 'files': [DB_FILE, LOG_FILE], 'dirs': [VENV_DIR]}
    
    for svc in targets['services']:
        run_step(f"Stop {svc}", ['systemctl', 'stop', svc], ignore_error=True)
        run_step(f"Disable {svc}", ['systemctl', 'disable', svc], ignore_error=True)
        if os.path.exists(f"/etc/systemd/system/{svc}.service"): os.remove(f"/etc/systemd/system/{svc}.service")
    
    run_step("Reloading Daemon", ['systemctl', 'daemon-reload'], ignore_error=True)

    for d in targets['dirs']:
        if os.path.exists(d): shutil.rmtree(d)
    for f in targets['files']:
        if os.path.exists(f): os.remove(f)

    try: os.remove(os.path.abspath(__file__))
    except: pass
    print("âœ… System Cleaned.")
    sys.exit(0)

if __name__ == '__main__':
    if len(sys.argv) > 1:
        if sys.argv[1] == '--install': setup_system()
        elif sys.argv[1] == '--uninstall': uninstall_system()
    ensure_venv()

# --- Imports (Post-Env Check) ---
try:
    from flask import Flask, request, jsonify, abort, send_file
    from apscheduler.schedulers.background import BackgroundScheduler
    import requests
    import feedparser
    from bs4 import BeautifulSoup
except ImportError:
    print("âš ï¸  Libraries missing. Run: sudo ./nexus.py --install")
    sys.exit(1)

# --- Database & Models ---
def get_db():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    c = conn.cursor()
    c.execute('CREATE TABLE IF NOT EXISTS folders (id INTEGER PRIMARY KEY, name TEXT UNIQUE)')
    c.execute("INSERT OR IGNORE INTO folders (id, name) VALUES (1, 'General'), (999, 'Read Later')")
    
    c.execute('''CREATE TABLE IF NOT EXISTS feeds (
        id INTEGER PRIMARY KEY, folder_id INTEGER, title TEXT, url TEXT UNIQUE, 
        site_url TEXT, favicon TEXT, is_youtube BOOLEAN DEFAULT 0, 
        is_reddit BOOLEAN DEFAULT 0, notify BOOLEAN DEFAULT 0, 
        regex_filter TEXT, killfile_tags TEXT,
        last_checked TIMESTAMP, error_count INTEGER DEFAULT 0
    )''')
    
    c.execute('''CREATE TABLE IF NOT EXISTS items (
        id INTEGER PRIMARY KEY, feed_id INTEGER, guid TEXT, title TEXT, 
        link TEXT, summary TEXT, content TEXT, published TIMESTAMP, author TEXT,
        is_read BOOLEAN DEFAULT 0, is_bookmarked BOOLEAN DEFAULT 0, 
        user_comment TEXT, tags TEXT, 
        read_progress FLOAT DEFAULT 0,
        sentiment TEXT, ai_summary TEXT, read_time_min INTEGER,
        image_url TEXT,
        UNIQUE(feed_id, guid)
    )''')
    
    c.execute('CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)')
    
    c.execute('CREATE INDEX IF NOT EXISTS idx_items_read ON items(is_read)')
    c.execute('CREATE INDEX IF NOT EXISTS idx_items_feed ON items(feed_id)')
    c.execute('CREATE INDEX IF NOT EXISTS idx_items_pub ON items(published)')
    
    try: c.execute("ALTER TABLE items ADD COLUMN image_url TEXT")
    except: pass
    
    conn.commit()
    conn.close()

# --- Logic & AI Helpers ---
def detect_platform(url):
    is_yt = 'youtube.com' in url or 'youtu.be' in url
    is_rd = 'reddit.com' in url
    if is_yt:
        if 'channel/' in url: url = f"https://www.youtube.com/feeds/videos.xml?channel_id={url.split('channel/')[1].split('/')[0]}"
        elif 'user/' in url: url = f"https://www.youtube.com/feeds/videos.xml?user={url.split('user/')[1].split('/')[0]}"
    if is_rd and not url.endswith('.rss'): url = url.rstrip('/') + '/.rss'
    return url, is_yt, is_rd

def get_favicon(url):
    try: return f"https://www.google.com/s2/favicons?domain={urlparse(url).netloc}&sz=32"
    except: return ""

def calculate_read_time(text):
    words = len(text.split())
    return max(1, round(words / 200))

def analyze_sentiment(text):
    pos = {'awesome', 'good', 'great', 'amazing', 'love', 'profit', 'bull', 'growth', 'success', 'exciting', 'breakthrough', 'innovative'}
    neg = {'bad', 'terrible', 'hate', 'loss', 'crash', 'crisis', 'warn', 'bear', 'dead', 'fail', 'danger', 'disastrous', 'volatile'}
    words = set(text.lower().split())
    score = len(words & pos) - len(words & neg)
    if score > 0: return "positive"
    if score < 0: return "negative"
    return "neutral"

def auto_tag(text):
    text = text.lower()
    tags = []
    categories = {
        'Tech': ['python', 'code', 'software', 'ai', 'linux', 'cyber', 'data', 'api', 'app', 'web', 'cloud'],
        'Finance': ['market', 'stock', 'crypto', 'bitcoin', 'economy', 'bank', 'money', 'invest'],
        'Science': ['space', 'nasa', 'health', 'climate', 'physics', 'biology', 'study', 'research'],
        'Politics': ['policy', 'election', 'law', 'senate', 'president', 'vote', 'government'],
        'Gaming': ['game', 'nintendo', 'steam', 'playstation', 'xbox', 'release', 'mod'],
        'Design': ['ui', 'ux', 'css', 'font', 'color', 'art', 'video']
    }
    for cat, keywords in categories.items():
        if any(k in text for k in keywords):
            tags.append(cat)
    return ",".join(tags)

def extract_image(entry, soup):
    if 'media_content' in entry:
        for m in entry.media_content:
            if m.get('medium') == 'image' or m.get('type', '').startswith('image'): return m.get('url')
    if 'media_thumbnail' in entry and len(entry.media_thumbnail) > 0: return entry.media_thumbnail[0].get('url')
    if 'enclosures' in entry:
        for enc in entry.enclosures:
            if enc.get('type', '').startswith('image'): return enc.get('href')
    img = soup.find('img')
    if img and img.get('src'): return img.get('src')
    return None

def fetch_feed(feed_id, url, regex_filter=None, killfile=None):
    try:
        d = feedparser.parse(url)
        if d.bozo and not d.entries: raise Exception("Parse Error")
        conn = get_db()
        
        site_link = d.feed.get('link', url)
        title = d.feed.get('title', 'Unknown Feed')
        conn.execute("UPDATE feeds SET title=?, site_url=?, last_checked=?, error_count=0 WHERE id=?", 
                  (title, site_link, datetime.now(), feed_id))
        
        count = 0
        for e in d.entries:
            content_blob = (e.get('title', '') + " " + e.get('summary', '')).lower()
            if regex_filter and re.search(regex_filter, content_blob, re.IGNORECASE): continue
            if killfile and any(k.strip().lower() in content_blob for k in killfile.split(',')): continue

            guid = e.get('id', e.get('link'))
            if not guid: continue
            
            exists = conn.execute("SELECT 1 FROM items WHERE feed_id=? AND guid=?", (feed_id, guid)).fetchone()
            if not exists:
                pub = datetime.now()
                if 'published_parsed' in e and e.published_parsed: pub = datetime(*e.published_parsed[:6])
                
                content = e.get('content', [{'value': ''}])[0]['value'] or e.get('summary', '') or e.get('description', '')
                soup = BeautifulSoup(content, "html.parser")
                plain_text = soup.get_text()
                
                image_url = extract_image(e, soup)
                read_time = calculate_read_time(plain_text)
                sentiment = analyze_sentiment(plain_text)
                tags = auto_tag(plain_text + " " + e.get('title', ''))
                
                conn.execute('''INSERT INTO items (feed_id, guid, title, link, summary, content, published, author, read_time_min, sentiment, tags, image_url) 
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                    (feed_id, guid, e.get('title', '(No Title)'), e.get('link'), plain_text[:300]+"...", content, pub, e.get('author', ''), read_time, sentiment, tags, image_url))
                count += 1
        conn.commit()
        conn.close()
        return count
    except Exception as e:
        conn = get_db()
        conn.execute("UPDATE feeds SET error_count = error_count + 1 WHERE id=?", (feed_id,))
        conn.commit()
        conn.close()
        return 0

def background_worker():
    conn = get_db()
    feeds = conn.execute("SELECT id, url, regex_filter, killfile_tags FROM feeds").fetchall()
    conn.close()
    print(f"Fetching {len(feeds)} feeds...")
    for f in feeds:
        fetch_feed(f['id'], f['url'], f['regex_filter'], f['killfile_tags'])

# --- App Setup ---
logging.basicConfig(filename=LOG_FILE, level=logging.ERROR)
app = Flask(__name__)
app.secret_key = SECRET_KEY
scheduler = BackgroundScheduler()
scheduler.add_job(func=background_worker, trigger="interval", minutes=15)
scheduler.start()

# --- Frontend (AngularJS) ---
HTML = """
<!DOCTYPE html>
<html lang="en" ng-app="nexusApp" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusRSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-sanitize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.6.5/mousetrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: {
                        slate: { 900: '#0f172a', 950: '#020617' },
                        nexus: { 500: '#6366f1', 600: '#4f46e5' },
                        sepia: { bg: '#fbf0d9', text: '#433422', accent: '#8f5902' }
                    },
                    animation: { 
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'fade-in-up': 'fadeInUp 0.5s ease-out'
                    },
                    keyframes: {
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        fadeInUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=JetBrains+Mono&display=swap');
        
        body { 
            background-color: #020617; 
            background-image: radial-gradient(circle at 80% 20%, #1e1b4b 0%, transparent 20%), radial-gradient(circle at 20% 80%, #312e81 0%, transparent 20%);
            background-attachment: fixed;
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
        }
        
        /* Liquid Glass Morphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            opacity: 0; transition: opacity 0.3s;
        }
        .glass-card:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px) scale(1.005);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
        }

        /* Radius Customization */
        .radius-square { border-radius: 4px !important; }
        .radius-square .glass-card { border-radius: 2px !important; }
        
        /* Angular Animate */
        .animate-fade-ng.ng-enter { transition: 0.3s ease-out; opacity: 0; transform: scale(0.98); }
        .animate-fade-ng.ng-enter-active { opacity: 1; transform: scale(1); }
        .animate-fade-ng.ng-leave { transition: 0.2s ease-in; opacity: 1; transform: scale(1); }
        .animate-fade-ng.ng-leave-active { opacity: 0; transform: scale(0.98); }

        .feed-item.ng-enter { transition: 0.3s ease-out; opacity: 0; transform: translateY(10px); }
        .feed-item.ng-enter-active { opacity: 1; transform: translateY(0); }

        .reader-overlay.ng-enter { transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); opacity: 0; }
        .reader-overlay.ng-enter-active { transform: translateY(0); opacity: 1; }
        .reader-overlay.ng-leave { transition: 0.3s ease-in; transform: translateY(0); opacity: 1; }
        .reader-overlay.ng-leave-active { transform: translateY(100%); opacity: 0; }

        /* Bionic */
        b.bionic { font-weight: 800; color: inherit; opacity: 1 !important; }
        
        /* Sepia Theme */
        .sepia-theme { background: #fbf0d9 !important; color: #433422 !important; }
        .sepia-theme body { background: #fbf0d9; background-image: none; }
        .sepia-theme .glass-panel, .sepia-theme .glass-card { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(20px);
            border-color: rgba(67, 52, 34, 0.1); 
            color: #433422;
            box-shadow: 0 10px 30px -5px rgba(67, 52, 34, 0.1);
        }
        .sepia-theme .glass-card:hover { background: rgba(255, 255, 255, 0.95); border-color: #8f5902; }
        .sepia-theme h1, .sepia-theme h2, .sepia-theme h3, .sepia-theme strong, .sepia-theme b { color: #2c1a08 !important; }
        .sepia-theme .text-slate-400, .sepia-theme .text-slate-500 { color: #7c6852 !important; }
        .sepia-theme .text-white { color: #2c1a08 !important; }
        .sepia-theme .bg-slate-950, .sepia-theme .bg-slate-900 { background: #f3e5c9 !important; border-color: #e6d5b3 !important; }
        .sepia-theme .text-indigo-400 { color: #8f5902 !important; }
        
        /* Custom Colors based on config */
        .accent-emerald .text-indigo-400 { color: #34d399 !important; }
        .accent-emerald .bg-indigo-600 { background-color: #059669 !important; }
        .accent-rose .text-indigo-400 { color: #fb7185 !important; }
        .accent-rose .bg-indigo-600 { background-color: #e11d48 !important; }
        .accent-amber .text-indigo-400 { color: #fbbf24 !important; }
        .accent-amber .bg-indigo-600 { background-color: #d97706 !important; }

        /* Scroll Progress */
        .scroll-progress { position: fixed; top: 0; left: 0; height: 3px; background: #6366f1; z-index: 100; transition: width 0.1s; }

        [ng-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body ng-controller="MainController" ng-class="['accent-'+config.accent, {'sepia-theme': config.theme === 'sepia', 'dyslexic': config.font === 'dyslexic', 'radius-square': config.radius === 'square'}]" class="antialiased selection:bg-indigo-500/30" style="font-size: {{config.fontSize}}px; font-family: {{getFontFamily()}}">
    
    <style ng-if="config.customCSS">{{config.customCSS}}</style>

    <div class="h-screen flex w-full p-4 gap-5 box-border" ng-class="{'flex-row-reverse': config.sidebarSide === 'right'}">
        
        <!-- SIDEBAR TILE -->
        <aside class="glass-panel rounded-[32px] flex-col flex-shrink-0 transition-all duration-500 ease-in-out z-20 flex"
               ng-class="{'w-[320px] opacity-100 translate-x-0': sidebarOpen && !zenMode, 'w-0 opacity-0 -translate-x-10 overflow-hidden p-0 border-0': !sidebarOpen || zenMode}">
            
            <!-- Sidebar Header -->
            <div class="p-6 flex justify-between items-center shrink-0 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20 ring-1 ring-white/10">
                        <icon name="'zap'" class="w-6 h-6 text-white"></icon>
                    </div>
                    <div>
                        <h1 class="font-black text-xl tracking-tight text-white leading-none">NEXUS</h1>
                        <span class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest">OS v0.1</span>
                    </div>
                </div>
                <button ng-click="openModal('add')" class="p-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 text-slate-400 hover:text-white transition-all shadow-sm">
                    <icon name="'plus'" class="w-5 h-5"></icon>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto px-4 py-6 space-y-8">
                
                <!-- Smart Views -->
                <div class="space-y-2">
                    <div class="px-2 mb-3 text-[10px] font-extrabold text-slate-500 uppercase tracking-widest opacity-70">Smart Views</div>
                    
                    <div ng-click="setFilter('all')" class="nav-item group relative" ng-class="{'active': viewState.filter === 'all'}">
                        <div class="flex items-center w-full">
                            <div class="w-8 flex justify-center"><icon name="'inbox'" class="w-5 h-5 transition-colors" ng-class="viewState.filter === 'all' ? 'text-white' : 'text-slate-500 group-hover:text-slate-300'"></icon></div>
                            <span class="font-medium ml-1">Inbox</span>
                        </div>
                        <span class="text-xs font-bold bg-indigo-500 text-white px-2 py-0.5 rounded-full shadow-sm shadow-indigo-500/50 absolute right-3" ng-if="viewState.counts.all">{{viewState.counts.all}}</span>
                    </div>

                    <div ng-click="viewDigest()" class="nav-item group relative">
                        <div class="flex items-center w-full">
                            <div class="w-8 flex justify-center"><icon name="'sun'" class="w-5 h-5 transition-colors text-amber-400"></icon></div>
                            <span class="font-medium ml-1">Daily Digest</span>
                        </div>
                    </div>

                    <div ng-click="setFilter('bookmarks')" class="nav-item group relative" ng-class="{'active': viewState.filter === 'bookmarks'}">
                        <div class="flex items-center w-full">
                            <div class="w-8 flex justify-center"><icon name="'star'" class="w-5 h-5 transition-colors" ng-class="viewState.filter === 'bookmarks' ? 'text-yellow-400' : 'text-slate-500 group-hover:text-slate-300'"></icon></div>
                            <span class="font-medium ml-1">Bookmarks</span>
                        </div>
                    </div>

                    <div ng-click="setFilter('folder:999')" class="nav-item group relative" ng-class="{'active': viewState.filter === 'folder:999'}">
                        <div class="flex items-center w-full">
                            <div class="w-8 flex justify-center"><icon name="'clock'" class="w-5 h-5 transition-colors" ng-class="viewState.filter === 'folder:999' ? 'text-emerald-400' : 'text-slate-500 group-hover:text-slate-300'"></icon></div>
                            <span class="font-medium ml-1">Read Later</span>
                        </div>
                    </div>

                    <div ng-click="surpriseMe()" class="nav-item group relative">
                         <div class="flex items-center w-full">
                            <div class="w-8 flex justify-center"><icon name="'sparkles'" class="w-5 h-5 transition-colors text-purple-400"></icon></div>
                            <span class="font-medium ml-1">Surprise Me</span>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-px w-full bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>

                <!-- Collections -->
                <div class="space-y-2">
                    <div class="px-2 mb-3 flex justify-between items-center">
                        <span class="text-[10px] font-extrabold text-slate-500 uppercase tracking-widest opacity-70">Collections</span>
                        <button ng-click="openModal('addCollection')" class="text-slate-500 hover:text-white transition-colors" title="Add Collection"><icon name="'plus'" class="w-3 h-3"></icon></button>
                    </div>
                    <div ng-repeat="f in viewState.folders" ng-if="f.id !== 1 && f.id !== 999" class="nav-item group relative flex justify-between items-center group" ng-class="{'active': viewState.filter === 'folder:'+f.id}">
                        <div class="flex items-center w-full" ng-click="setFilter('folder:'+f.id)">
                            <div class="w-8 flex justify-center"><icon name="'folder'" class="w-5 h-5 text-slate-600 group-hover:text-slate-400 transition-colors"></icon></div>
                            <span class="font-medium ml-1">{{f.name}}</span>
                        </div>
                        <button ng-click="deleteFolder(f.id, $event)" class="text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><icon name="'trash'" class="w-3 h-3"></icon></button>
                    </div>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-white/5 flex items-center justify-between text-slate-500 shrink-0 bg-black/10 backdrop-blur-md rounded-b-[32px]">
                <div class="flex gap-1">
                    <button ng-click="openModal('settings')" class="p-2.5 hover:bg-white/10 rounded-xl transition-colors" title="Settings"><icon name="'settings'" class="w-5 h-5"></icon></button>
                    <button ng-click="openModal('cmd')" class="p-2.5 hover:bg-white/10 rounded-xl transition-colors" title="Command"><icon name="'command'" class="w-5 h-5"></icon></button>
                </div>
                <button ng-click="refreshFeeds()" class="p-2.5 hover:bg-indigo-500/20 hover:text-indigo-400 rounded-xl transition-colors" ng-class="{'animate-spin': viewState.refreshing}" title="Refresh All">
                    <icon name="'refresh'" class="w-5 h-5"></icon>
                </button>
            </div>
        </aside>

        <!-- MAIN FEED TILE -->
        <main class="glass-panel rounded-[32px] flex-1 flex flex-col min-w-0 relative overflow-hidden transition-all duration-500" ng-class="{'col-span-2': !sidebarOpen}">
            
            <!-- Header -->
            <header ng-if="!zenMode" class="h-20 flex items-center justify-between px-8 z-10 shrink-0 border-b border-white/5">
                <div class="flex items-center gap-5">
                    <button ng-click="toggleSidebar()" class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-xl">
                        <icon name="'menu'" class="w-6 h-6"></icon>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white capitalize tracking-tight animate-fade-ng">{{ getTitle() }}</h2>
                        <p class="text-xs text-slate-500 font-medium mt-0.5">{{ viewState.items.length }} articles</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center mr-4 bg-white/5 rounded-lg p-1 border border-white/5">
                        <button ng-click="toggleHideRead()" class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors" ng-class="config.hideRead ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white'">Hide Read</button>
                    </div>
                    <button ng-click="markAllRead()" class="p-2 hover:bg-white/5 rounded-xl text-slate-400 hover:text-white transition-colors" title="Mark All Read">
                        <icon name="'check-circle'" class="w-5 h-5"></icon>
                    </button>
                    <div class="h-8 w-px bg-white/10 mx-2"></div>
                    <button ng-click="toggleZenMode()" class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-indigo-500/20 hover:text-indigo-300 rounded-full text-xs font-bold border border-white/5 hover:border-indigo-500/30 transition-all group shadow-sm">
                        <icon name="'eye'" class="w-4 h-4 text-slate-400 group-hover:text-indigo-400"></icon> Zen Mode
                    </button>
                </div>
            </header>

            <!-- Feed List -->
            <div class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth relative">
                
                <!-- Skeleton Loader -->
                <div ng-if="viewState.initialLoad" class="max-w-5xl mx-auto space-y-4">
                    <div ng-repeat="i in [1,2,3,4]" class="h-40 bg-white/5 rounded-3xl animate-pulse border border-white/5"></div>
                </div>

                <!-- Feed Items -->
                <div class="mx-auto space-y-5 pb-24 transition-all duration-500" ng-class="{'max-w-3xl': zenMode, 'max-w-5xl': !zenMode}">
                    <div ng-repeat="item in viewState.items track by item.id" 
                         ng-click="openItem(item)"
                         ng-show="!config.hideRead || !item.is_read"
                         class="feed-item glass-card p-7 rounded-[24px] cursor-pointer relative group overflow-hidden"
                         ng-class="{'opacity-50 grayscale': item.is_read, 'compact-card': config.density === 'compact'}">
                         
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div class="flex flex-wrap items-center gap-3 text-xs font-semibold text-slate-400">
                                <div class="flex items-center gap-2 bg-slate-950/50 px-2 py-1 rounded-lg border border-white/5">
                                    <img ng-if="item.favicon" ng-src="{{item.favicon}}" class="w-3 h-3 rounded-sm opacity-80" onerror="this.style.display='none'"/>
                                    <span class="text-slate-300">{{item.feed_title}}</span>
                                </div>
                                <span ng-if="config.showMetadata">{{item.read_time_min}}m read</span>
                                <span ng-if="item.tags && config.showMetadata" ng-repeat="tag in item.tags.split(',')" class="text-[10px] px-2 py-0.5 rounded-md border border-white/10 bg-white/5 text-indigo-300" ng-class="{'bg-indigo-500/20 border-indigo-500/30 text-white': config.highlightKeywords && config.keywords.includes(tag)}">{{tag}}</span>
                                <span ng-if="item.sentiment === 'positive' && config.showSentiment" class="text-emerald-400 bg-emerald-400/10 px-2 py-0.5 rounded text-[10px]">Positive</span>
                                <span ng-if="item.sentiment === 'negative' && config.showSentiment" class="text-rose-400 bg-rose-400/10 px-2 py-0.5 rounded text-[10px]">Negative</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-6">
                            <div class="flex-1">
                                <h3 class="text-2xl font-bold text-slate-100 mb-3 group-hover:text-indigo-300 leading-tight transition-colors tracking-tight relative z-10">{{item.title}}</h3>
                                <p ng-if="config.density !== 'compact' && config.showSummary" class="text-base text-slate-400 line-clamp-2 leading-relaxed opacity-80 font-light relative z-10" ng-bind-html="cleanSummary(item.summary)"></p>
                            </div>
                            <div ng-if="item.image_url && config.showImages && config.density !== 'compact'" class="w-32 h-24 rounded-xl bg-black/20 overflow-hidden shrink-0">
                                <img ng-src="{{item.image_url}}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="absolute top-6 right-6 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0 flex gap-2 z-20">
                            <button ng-click="toggleBookmark(item, $event)" 
                                    class="p-2.5 rounded-full bg-slate-950 border border-white/10 backdrop-blur-md hover:border-yellow-500/50 shadow-lg transition-all"
                                    ng-class="{'text-yellow-400 border-yellow-500/50 bg-yellow-900/10': item.is_bookmarked, 'text-slate-400': !item.is_bookmarked}">
                                <icon name="item.is_bookmarked ? 'star-filled' : 'star'" class="w-5 h-5"></icon>
                            </button>
                             <button ng-click="deleteItem(item.id, $event)" class="p-2.5 rounded-full bg-slate-950 border border-white/10 backdrop-blur-md hover:border-rose-500/50 shadow-lg transition-all text-slate-400 hover:text-rose-400">
                                <icon name="'trash'" class="w-5 h-5"></icon>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div ng-if="!viewState.initialLoad && viewState.items.length === 0" class="text-center pt-32 animate-fade-ng">
                        <div class="inline-flex items-center justify-center w-24 h-24 rounded-[32px] bg-gradient-to-br from-slate-800 to-slate-900 border border-white/5 mb-8 shadow-2xl">
                            <icon name="'check'" class="w-10 h-10 text-slate-600"></icon>
                        </div>
                        <h3 class="text-3xl font-black text-white tracking-tight">Zero Inbox</h3>
                        <p class="text-slate-500 mt-3 text-lg">You're completely up to date.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- READER OVERLAY -->
        <div ng-if="activeItem" class="reader-overlay fixed inset-0 z-50 flex flex-col bg-slate-950/95 backdrop-blur-3xl" ng-class="{'sepia-theme': config.theme === 'sepia'}">
            <div class="scroll-progress" style="width: {{scrollProgress}}%"></div>
            
            <!-- Hero Image Background -->
            <div ng-if="activeItem.image_url" class="absolute top-0 left-0 w-full h-96 opacity-20 pointer-events-none mask-image-b-0">
                <img ng-src="{{activeItem.image_url}}" class="w-full h-full object-cover blur-2xl">
            </div>

            <div class="h-20 flex items-center justify-between px-4 md:px-12 border-b border-white/5 z-50 bg-slate-950/80 backdrop-blur-md relative">
                <button ng-click="closeItem()" class="p-3 -ml-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors">
                    <icon name="'chevron-left'" class="w-6 h-6"></icon>
                </button>
                
                <div class="flex items-center gap-2 bg-slate-900/50 p-1.5 rounded-2xl border border-white/5 shadow-inner">
                     <button ng-click="speakArticle()" class="p-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-colors" title="Listen to Article">
                        <icon name="'mic'" class="w-5 h-5" ng-class="{'text-indigo-400 animate-pulse': speaking}"></icon>
                    </button>
                    <button ng-click="copyLink()" class="p-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-colors" title="Copy Link">
                        <icon name="'link'" class="w-5 h-5"></icon>
                    </button>
                     <button ng-click="shareArticle()" class="p-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-colors" title="Share">
                        <icon name="'share'" class="w-5 h-5"></icon>
                    </button>
                    <div class="w-px h-4 bg-white/10 mx-1"></div>
                    <button ng-click="config.bionic = !config.bionic; saveSettings()" class="px-4 py-2 rounded-xl text-xs font-bold transition-all"
                            ng-class="{'bg-indigo-600 text-white shadow-lg shadow-indigo-500/25': config.bionic, 'text-slate-400 hover:text-white': !config.bionic}">
                        BIONIC
                    </button>
                    <a ng-href="{{activeItem.link}}" target="_blank" class="p-2 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-colors">
                        <icon name="'external-link'" class="w-5 h-5"></icon>
                    </a>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto relative scroll-smooth" id="reader-scroll" on-scroll="updateScrollProgress()">
                <article class="max-w-3xl mx-auto px-6 py-12 md:py-20 animate-fade-in-up">
                    
                    <!-- Hero Image -->
                    <div ng-if="activeItem.image_url" class="mb-12 rounded-3xl overflow-hidden shadow-2xl border border-white/10 relative aspect-video group">
                        <img ng-src="{{activeItem.image_url}}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-950/50 to-transparent"></div>
                    </div>

                    <header class="mb-16 text-center">
                        <div class="flex items-center justify-center gap-3 text-sm text-slate-500 font-mono mb-8">
                            <span class="text-indigo-400 font-bold bg-indigo-400/10 px-3 py-1 rounded-full border border-indigo-400/20">{{ activeItem.feed_title }}</span>
                            <span>{{ activeItem.published | date:'mediumDate' }}</span>
                        </div>
                        <h1 class="text-4xl md:text-7xl font-black leading-tight tracking-tight text-white mb-10">{{ activeItem.title }}</h1>
                        <div ng-if="activeItem.author" class="inline-block bg-white/5 px-5 py-2 rounded-full text-sm text-slate-300 border border-white/5">
                            By {{ activeItem.author }}
                        </div>
                    </header>

                    <div class="prose prose-invert prose-xl max-w-none prose-p:text-slate-300 prose-a:text-indigo-400 prose-headings:text-white prose-strong:text-white"
                         ng-class="{'font-serif': config.fontSerif, 'leading-relaxed': config.lineHeight === 'normal', 'leading-loose': config.lineHeight === 'loose'}" 
                         ng-bind-html="renderedContent">
                    </div>
                    
                    <div class="mt-32 pt-16 border-t border-white/5 text-center text-slate-600 flex flex-col items-center">
                        <div class="w-2 h-2 bg-slate-700 rounded-full mx-auto mb-6"></div>
                        <p class="text-sm uppercase tracking-widest mb-4">End of Article</p>
                        <button ng-click="scrollToTop()" class="p-3 rounded-full bg-white/5 hover:bg-white/10 transition-colors"><icon name="'arrow-up'" class="w-5 h-5"></icon></button>
                    </div>
                </article>
            </div>
        </div>

        <!-- ZEN MODE ESCAPE HATCH -->
        <button ng-if="zenMode" ng-click="toggleZenMode()" class="fixed bottom-8 right-8 z-50 bg-slate-900/80 hover:bg-indigo-600 text-slate-400 hover:text-white p-4 rounded-full shadow-2xl border border-white/10 transition-all duration-300 group opacity-20 hover:opacity-100 backdrop-blur-md" title="Exit Zen Mode">
            <icon name="'minimize'" class="w-6 h-6"></icon>
        </button>

        <!-- DAILY DIGEST OVERLAY -->
        <div ng-if="viewState.showDigest" class="reader-overlay fixed inset-0 z-50 flex flex-col bg-[#f4f1ea] text-[#2c2216]" style="font-family: 'Merriweather', serif;">
            <div class="h-20 flex items-center justify-between px-8 border-b-2 border-black/5 bg-[#f4f1ea]/90 backdrop-blur sticky top-0 z-50">
                <button ng-click="viewState.showDigest = false" class="flex items-center gap-2 text-[#5c4d3c] hover:text-black transition-colors font-bold uppercase tracking-wide text-sm">
                    <icon name="'chevron-left'" class="w-5 h-5"></icon> Close
                </button>
                <span class="font-black uppercase tracking-[0.2em] text-xs text-[#8c7b66] border border-[#8c7b66] px-3 py-1 rounded-full">Daily Edition</span>
                <div class="w-20"></div>
            </div>
            <div class="flex-1 overflow-y-auto px-4 py-16 bg-[url('https://www.transparenttextures.com/patterns/cream-paper.png')]">
                <div class="max-w-4xl mx-auto">
                    <header class="text-center mb-20 border-b-4 border-black pb-12">
                        <h1 class="text-7xl md:text-9xl font-black mb-6 tracking-tighter leading-none">THE NEXUS</h1>
                        <div class="flex justify-between items-center border-t-2 border-black pt-4 text-sm font-bold uppercase tracking-widest text-[#5c4d3c]">
                            <span>Vol. {{ digestDate | date:'yyyy' }}</span>
                            <span>{{ digestDate | date:'fullDate' }}</span>
                            <span>Free Edition</span>
                        </div>
                    </header>
                    
                    <div class="grid gap-16">
                        <div ng-repeat="item in digestItems" class="border-b border-black/10 pb-16 last:border-0 grid md:grid-cols-4 gap-8">
                            <div class="md:col-span-1 text-right md:border-r md:border-black/10 md:pr-8 pt-2">
                                <div class="text-xs font-black text-[#c0392b] mb-2 uppercase tracking-widest">{{item.feed_title}}</div>
                                <div class="text-xs text-slate-500 font-sans">{{item.published | date:'shortTime'}}</div>
                            </div>
                            <div class="md:col-span-3">
                                <h2 class="text-4xl font-black mb-6 leading-tight hover:text-[#c0392b] transition-colors cursor-pointer" ng-click="openItem(item); viewState.showDigest = false">{{item.title}}</h2>
                                <p class="text-xl leading-relaxed text-[#4a3b2a] font-serif" ng-bind-html="cleanSummary(item.summary)"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-32 text-center">
                        <p class="font-black text-4xl opacity-10">Â·Â·Â·</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS MODAL -->
        <div ng-if="modals.settings" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-ng" ng-click="closeModals()">
            <div class="glass-panel bg-slate-900/95 rounded-[32px] w-full max-w-3xl p-0 shadow-2xl transform transition-all overflow-hidden" ng-click="$event.stopPropagation()">
                <div class="grid grid-cols-3 h-[70vh]">
                    <!-- Sidebar -->
                    <div class="col-span-1 bg-black/20 border-r border-white/5 p-6 space-y-1">
                        <h2 class="text-xl font-bold text-white mb-6 px-2">Settings</h2>
                        <button ng-click="activeTab = 'general'" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition-colors" ng-class="activeTab === 'general' ? 'bg-white/5 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-slate-200'">General</button>
                        <button ng-click="activeTab = 'appearance'" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition-colors" ng-class="activeTab === 'appearance' ? 'bg-white/5 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-slate-200'">Appearance</button>
                        <button ng-click="activeTab = 'reading'" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition-colors" ng-class="activeTab === 'reading' ? 'bg-white/5 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-slate-200'">Reading</button>
                        <button ng-click="activeTab = 'feeds'" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition-colors" ng-class="activeTab === 'feeds' ? 'bg-white/5 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-slate-200'">Feeds</button>
                        <button ng-click="activeTab = 'system'" class="w-full text-left px-4 py-3 rounded-xl font-medium text-sm transition-colors" ng-class="activeTab === 'system' ? 'bg-white/5 text-white' : 'text-slate-400 hover:bg-white/5 hover:text-slate-200'">System</button>
                    </div>
                    
                    <!-- Content -->
                    <div class="col-span-2 p-8 overflow-y-auto" ng-init="activeTab = 'general'">
                        
                        <!-- General Tab -->
                        <div ng-show="activeTab === 'general'" class="space-y-8 animate-fade-ng">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-6">General Settings</h3>
                            <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Sidebar Position</label>
                                <div class="flex p-1 bg-black/20 rounded-xl border border-white/5">
                                    <button ng-click="config.sidebarSide='left'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.sidebarSide!=='right' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Left</button>
                                    <button ng-click="config.sidebarSide='right'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.sidebarSide==='right' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Right</button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Digest Timeframe (Days)</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" min="1" max="7" ng-model="config.digestWindow" ng-change="saveSettings()" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <span class="text-sm text-white font-mono w-8 text-center">{{config.digestWindow || 3}}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Appearance Tab -->
                        <div ng-show="activeTab === 'appearance'" class="space-y-8 animate-fade-ng">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-6">Visual Customization</h3>
                            <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Theme</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button ng-click="config.theme='dark'; saveSettings()" class="p-3 rounded-xl border border-white/10 bg-slate-900 flex items-center gap-3 transition-all" ng-class="{'ring-2 ring-indigo-500': config.theme=='dark'}">
                                        <div class="w-4 h-4 rounded-full bg-slate-700"></div> Dark
                                    </button>
                                    <button ng-click="config.theme='sepia'; saveSettings()" class="p-3 rounded-xl border border-white/10 bg-[#fbf0d9] text-slate-900 flex items-center gap-3 transition-all" ng-class="{'ring-2 ring-indigo-500': config.theme=='sepia'}">
                                        <div class="w-4 h-4 rounded-full bg-[#e6d5b3]"></div> Sepia
                                    </button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Accent Color</label>
                                <div class="flex gap-3">
                                    <button ng-click="config.accent='indigo'; saveSettings()" class="w-8 h-8 rounded-full bg-indigo-500 border-2 transition-transform active:scale-90" ng-class="config.accent=='indigo' ? 'border-white' : 'border-transparent opacity-50 hover:opacity-100'"></button>
                                    <button ng-click="config.accent='emerald'; saveSettings()" class="w-8 h-8 rounded-full bg-emerald-500 border-2 transition-transform active:scale-90" ng-class="config.accent=='emerald' ? 'border-white' : 'border-transparent opacity-50 hover:opacity-100'"></button>
                                    <button ng-click="config.accent='rose'; saveSettings()" class="w-8 h-8 rounded-full bg-rose-500 border-2 transition-transform active:scale-90" ng-class="config.accent=='rose' ? 'border-white' : 'border-transparent opacity-50 hover:opacity-100'"></button>
                                    <button ng-click="config.accent='amber'; saveSettings()" class="w-8 h-8 rounded-full bg-amber-500 border-2 transition-transform active:scale-90" ng-class="config.accent=='amber' ? 'border-white' : 'border-transparent opacity-50 hover:opacity-100'"></button>
                                </div>
                            </div>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Border Radius</label>
                                <div class="flex p-1 bg-black/20 rounded-xl border border-white/5">
                                    <button ng-click="config.radius='round'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.radius!=='square' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Rounded</button>
                                    <button ng-click="config.radius='square'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.radius==='square' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Square</button>
                                </div>
                            </div>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Custom CSS</label>
                                <textarea ng-model="config.customCSS" ng-change="saveSettings()" rows="4" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-xs font-mono text-slate-300 focus:border-indigo-500 outline-none" placeholder="body { ... }"></textarea>
                            </div>
                        </div>

                        <!-- Reading Tab -->
                        <div ng-show="activeTab === 'reading'" class="space-y-8 animate-fade-ng">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-6">Reading Experience</h3>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Words Per Minute (for Read Time)</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" min="100" max="600" step="10" ng-model="config.wpm" ng-change="saveSettings()" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <span class="text-sm text-white font-mono w-12 text-center">{{config.wpm || 200}}</span>
                                </div>
                            </div>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Font Family</label>
                                <select ng-model="config.font" ng-change="saveSettings()" class="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-white">
                                    <option value="inter">Inter (Default)</option>
                                    <option value="serif">Merriweather (Serif)</option>
                                    <option value="mono">JetBrains Mono</option>
                                    <option value="dyslexic">OpenDyslexic</option>
                                </select>
                            </div>
                            <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Reader Line Height</label>
                                <div class="flex p-1 bg-black/20 rounded-xl border border-white/5">
                                    <button ng-click="config.lineHeight='normal'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.lineHeight!=='loose' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Normal</button>
                                    <button ng-click="config.lineHeight='loose'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.lineHeight==='loose' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Loose</button>
                                </div>
                            </div>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Highlight Keywords (comma separated)</label>
                                <input type="text" ng-model="config.keywords" ng-change="saveSettings()" class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-indigo-500 outline-none" placeholder="AI, Crypto, Design...">
                            </div>
                        </div>
                        
                         <!-- Feeds Tab -->
                        <div ng-show="activeTab === 'feeds'" class="space-y-8 animate-fade-ng">
                            <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-6">Feed List Options</h3>
                             <div class="space-y-4">
                                <label class="text-sm font-medium text-white">Card Density</label>
                                <div class="flex p-1 bg-black/20 rounded-xl border border-white/5">
                                    <button ng-click="config.density='comfortable'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.density=='comfortable' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Comfortable</button>
                                    <button ng-click="config.density='compact'; saveSettings()" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all" ng-class="config.density=='compact' ? 'bg-indigo-600 text-white shadow' : 'text-slate-400 hover:text-white'">Compact</button>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 cursor-pointer">
                                    <span class="text-sm text-slate-300">Show Images</span>
                                    <input type="checkbox" ng-model="config.showImages" ng-change="saveSettings()" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-indigo-600 focus:ring-0">
                                </label>
                                <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 cursor-pointer">
                                    <span class="text-sm text-slate-300">Show Summaries</span>
                                    <input type="checkbox" ng-model="config.showSummary" ng-change="saveSettings()" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-indigo-600 focus:ring-0">
                                </label>
                                <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 cursor-pointer">
                                    <span class="text-sm text-slate-300">Show Sentiment</span>
                                    <input type="checkbox" ng-model="config.showSentiment" ng-change="saveSettings()" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-indigo-600 focus:ring-0">
                                </label>
                                <label class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5 cursor-pointer">
                                    <span class="text-sm text-slate-300">Show Metadata</span>
                                    <input type="checkbox" ng-model="config.showMetadata" ng-change="saveSettings()" class="w-4 h-4 rounded bg-slate-800 border-slate-600 text-indigo-600 focus:ring-0">
                                </label>
                            </div>
                        </div>

                        <!-- System Tab -->
                        <div ng-show="activeTab === 'system'" class="space-y-8 animate-fade-ng">
                            <h3 class="text-xs font-bold text-rose-400 uppercase tracking-wider mb-6">Data Management</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <a href="/api/backup" target="_blank" class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-300 hover:text-white text-sm font-medium transition-colors text-center">Download Database Backup</a>
                                <a href="/api/opml/export" target="_blank" class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-300 hover:text-white text-sm font-medium transition-colors text-center">Export OPML</a>
                                <div class="col-span-2">
                                    <label class="block w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-300 hover:text-white text-sm font-medium transition-colors text-center cursor-pointer">
                                        Import Database
                                        <input type="file" class="hidden" onchange="angular.element(this).scope().importDb(this)">
                                    </label>
                                </div>
                                <div class="col-span-2">
                                    <label class="block w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-300 hover:text-white text-sm font-medium transition-colors text-center cursor-pointer">
                                        Import OPML
                                        <input type="file" class="hidden" onchange="angular.element(this).scope().importOpml(this)">
                                    </label>
                                </div>
                            </div>
                            <h3 class="text-xs font-bold text-rose-400 uppercase tracking-wider mb-4 mt-8">Danger Zone</h3>
                            <div class="space-y-4">
                                <button ng-click="clearCache()" class="w-full py-3 rounded-xl border border-white/10 hover:bg-white/5 text-slate-400 hover:text-white text-sm font-medium transition-colors">Clear Cache & Reload</button>
                                <button ng-click="resetDb()" class="w-full py-3 rounded-xl border border-rose-500/20 hover:bg-rose-500/10 text-rose-400 hover:text-rose-300 text-sm font-medium transition-colors">Reset Database</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COMMAND PALETTE -->
        <div ng-if="modals.cmd" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-md flex items-start justify-center pt-[15vh] animate-fade-ng" ng-click="closeModals()">
            <div class="glass-panel bg-slate-900/90 rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden" ng-click="$event.stopPropagation()">
                <div class="p-5 border-b border-white/10 flex items-center">
                    <icon name="'search'" class="w-5 h-5 text-slate-500 mr-4"></icon>
                    <input auto-focus placeholder="Search..." class="bg-transparent border-none outline-none w-full text-xl text-white placeholder-slate-600 font-medium" ng-model="cmdQuery" ng-change="filterCommands()"/>
                    <span class="text-xs bg-white/10 text-slate-400 px-2 py-1 rounded-md border border-white/5 font-mono">ESC</span>
                </div>
                <div class="max-h-[60vh] overflow-y-auto p-2">
                    <div ng-repeat="group in filteredCommands" ng-if="group.items.length > 0">
                        <div class="px-4 py-2 text-[10px] font-bold text-indigo-400 uppercase tracking-widest mt-2">{{group.category}}</div>
                        <button ng-repeat="cmd in group.items" ng-click="cmd.action(); closeModals()" class="w-full text-left flex items-center justify-between px-4 py-3.5 hover:bg-white/5 rounded-xl group transition-colors">
                            <span class="text-slate-300 group-hover:text-white flex items-center gap-3 font-medium">
                                <icon name="cmd.icon" class="w-4 h-4 opacity-50"></icon> 
                                <span ng-bind-html="highlightMatch(cmd.label)"></span>
                            </span>
                            <span class="text-xs text-slate-600 font-mono bg-black/20 px-2 py-1 rounded" ng-if="cmd.shortcut">{{cmd.shortcut}}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Feed Modal -->
        <div ng-if="modals.add" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-ng" ng-click="closeModals()">
            <div class="glass-panel bg-slate-900/90 rounded-[32px] w-full max-w-md p-8 shadow-2xl transform transition-all" ng-click="$event.stopPropagation()">
                <h2 class="text-3xl font-black text-white mb-2 tracking-tight">Add Source</h2>
                <p class="text-slate-400 mb-8">Paste a URL. We'll handle the rest.</p>
                <form ng-submit="addFeed()">
                    <div class="space-y-4">
                        <input class="w-full bg-black/30 border border-white/10 text-white rounded-2xl p-4 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all placeholder-slate-600 text-lg" 
                               placeholder="https://..." ng-model="newFeed.url" auto-focus required />
                        <select class="w-full bg-black/30 border border-white/10 text-white rounded-2xl p-4 outline-none appearance-none" ng-model="newFeed.folder_id">
                            <option ng-repeat="f in viewState.folders" value="{{f.id}}">{{f.name}}</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" ng-click="closeModals()" class="px-6 py-3 text-slate-400 hover:text-white transition-colors font-medium">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/25 transition-all transform active:scale-95">
                            Add Feed
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Collection Modal -->
        <div ng-if="modals.addCollection" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-ng" ng-click="closeModals()">
            <div class="glass-panel bg-slate-900/90 rounded-[32px] w-full max-w-md p-8 shadow-2xl transform transition-all" ng-click="$event.stopPropagation()">
                <h2 class="text-3xl font-black text-white mb-2 tracking-tight">New Collection</h2>
                <p class="text-slate-400 mb-8">Create a new folder to organize your feeds.</p>
                <form ng-submit="addCollection()">
                    <div class="space-y-4">
                        <input class="w-full bg-black/30 border border-white/10 text-white rounded-2xl p-4 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all placeholder-slate-600 text-lg" 
                               placeholder="Collection Name" ng-model="newCollectionName" auto-focus required />
                    </div>
                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" ng-click="closeModals()" class="px-6 py-3 text-slate-400 hover:text-white transition-colors font-medium">Cancel</button>
                        <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/25 transition-all transform active:scale-95">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Shortcuts Help -->
        <div ng-if="modals.shortcuts" class="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4" ng-click="modals.shortcuts=false">
             <div class="glass-panel bg-slate-900/90 rounded-2xl p-8 shadow-2xl text-white">
                <h2 class="text-2xl font-bold mb-6">Keyboard Shortcuts</h2>
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-between mb-2"><span class="text-slate-400">Command Palette</span> <span class="font-mono bg-white/10 px-2 rounded">Cmd+K</span></div>
                        <div class="flex justify-between mb-2"><span class="text-slate-400">Zen Mode</span> <span class="font-mono bg-white/10 px-2 rounded">Z</span></div>
                        <div class="flex justify-between mb-2"><span class="text-slate-400">Close Item</span> <span class="font-mono bg-white/10 px-2 rounded">ESC</span></div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Toast Notification -->
        <div class="fixed bottom-8 right-8 z-[70] flex flex-col gap-2 pointer-events-none">
            <div ng-repeat="toast in toasts" class="glass-panel bg-slate-900/90 border border-indigo-500/30 text-white px-5 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-slide-up pointer-events-auto min-w-[300px]">
                <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0" ng-class="toast.type === 'error' ? 'bg-rose-500/20 text-rose-400' : 'bg-emerald-500/20 text-emerald-400'">
                    <icon name="toast.type === 'error' ? 'alert' : 'check'" class="w-5 h-5"></icon>
                </div>
                <div>
                    <p class="text-sm font-bold">{{toast.title}}</p>
                    <p class="text-xs text-slate-400 mt-0.5">{{toast.msg}}</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Styles for Angular Interactions -->
    <style>
        .nav-item { @apply rounded-2xl cursor-pointer transition-all text-sm text-slate-400 hover:bg-white/5 hover:text-slate-200 border border-transparent p-3; }
        .nav-item.active { @apply bg-indigo-600/10 text-indigo-300 border-indigo-500/20 shadow-lg shadow-indigo-500/5; }
        .compact-card { @apply p-4; }
        .compact-card h3 { @apply text-base mb-1; }
        .compact-card p { @apply text-xs line-clamp-1; }
    </style>

    <script>
        var app = angular.module('nexusApp', ['ngSanitize', 'ngAnimate']);

        app.component('icon', {
            bindings: { name: '<', class: '@' },
            controller: function($element) {
                const icons = {
                    menu: '<path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round"/>',
                    plus: '<path d="M12 5v14M5 12h14" stroke-width="2" stroke-linecap="round"/>',
                    check: '<path d="M20 6L9 17l-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>',
                    'check-circle': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>',
                    star: '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke-width="2" stroke-linejoin="round"/>',
                    'star-filled': '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor" stroke="none"/>',
                    inbox: '<path d="M22 12h-6l-2 3h-4l-2-3H2v12h20V12z"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>',
                    clock: '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
                    folder: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
                    settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" stroke-width="2" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke-width="2" stroke-linejoin="round"/>',
                    command: '<rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/><path d="M8 8h8v8H8z" stroke-width="2"/><path d="M12 8v8M8 12h8" stroke-width="2"/>',
                    eye: '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
                    zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
                    'chevron-left': '<polyline points="15 18 9 12 15 6"/>',
                    'external-link': '<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>',
                    sparkles: '<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>',
                    alert: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>',
                    sun: '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>',
                    search: '<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>',
                    minimize: '<polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/>',
                    x: '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>',
                    refresh: '<polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>',
                    trash: '<polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>',
                    link: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
                    mic: '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>',
                    share: '<path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>',
                    'arrow-up': '<line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>'
                };
                this.$onChanges = function() { $element.html(`<svg class="${this.class || 'w-4 h-4'}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" xmlns="http://www.w3.org/2000/svg">${icons[this.name] || ''}</svg>`); };
            }
        });

        app.directive('autoFocus', function($timeout) {
            return { link: (s, e) => $timeout(() => e[0].focus()) };
        });

        app.controller('MainController', function($scope, $http, $sce, $timeout) {
            $scope.viewState = { items: [], folders: [], filter: 'all', initialLoad: true, counts: {}, showDigest: false, refreshing: false };
            $scope.activeItem = null;
            $scope.sidebarOpen = true;
            $scope.zenMode = false;
            $scope.modals = { add: false, cmd: false, settings: false, shortcuts: false, addCollection: false };
            $scope.newFeed = { url: '', folder_id: '1', new_folder_name: '' };
            $scope.newCollectionName = '';
            $scope.config = { 
                bionic: false, 
                theme: 'dark', 
                font: 'inter', 
                fontSize: 16, 
                density: 'comfortable', 
                accent: 'indigo',
                sidebarSide: 'left',
                radius: 'round',
                showImages: true,
                showSummary: true,
                showSentiment: true,
                showMetadata: true,
                lineHeight: 'loose',
                digestWindow: 3,
                hideRead: false,
                highlightKeywords: false,
                keywords: '',
                wpm: 200,
                customCSS: ''
            };
            $scope.toasts = [];
            $scope.cmdQuery = '';
            $scope.allCommands = [];
            $scope.filteredCommands = [];
            $scope.digestItems = [];
            $scope.digestDate = new Date();
            $scope.scrollProgress = 0;
            $scope.speaking = false;

            // -- Settings & Persistence --
            $scope.loadSettings = function() {
                $http.get('/api/settings').then(function(res) {
                    if(res.data) {
                        $scope.config = {...$scope.config, ...res.data};
                        ['bionic', 'showImages', 'showSummary', 'showSentiment', 'showMetadata', 'hideRead', 'highlightKeywords'].forEach(k => {
                            if (typeof $scope.config[k] === 'string') $scope.config[k] = $scope.config[k] === 'true';
                        });
                        $scope.config.fontSize = parseInt($scope.config.fontSize);
                        $scope.config.wpm = parseInt($scope.config.wpm);
                        $scope.config.digestWindow = parseInt($scope.config.digestWindow) || 3;
                    }
                });
            };

            $scope.saveSettings = function() {
                $http.post('/api/settings', $scope.config);
                $scope.renderContent(); 
            };

            $scope.getFontFamily = function() {
                switch($scope.config.font) {
                    case 'serif': return "'Merriweather', serif";
                    case 'mono': return "'JetBrains Mono', monospace";
                    case 'dyslexic': return "'OpenDyslexic', sans-serif";
                    default: return "'Inter', sans-serif";
                }
            };

            // -- Data Fetching --
            $scope.fetchItems = function(silent = false) {
                if(!silent) $scope.viewState.loading = true;
                let url = `/api/items?filter=${$scope.viewState.filter}`;
                if ($scope.viewState.filter.startsWith('folder:')) {
                    url = `/api/items?folder=${$scope.viewState.filter.split(':')[1]}`;
                }
                $http.get(url).then(res => {
                    $scope.viewState.items = res.data;
                    $scope.viewState.loading = false;
                    $scope.viewState.initialLoad = false;
                    $scope.viewState.counts.all = res.data.filter(i => !i.is_read).length;
                    $scope.buildCommands();
                });
            };

            $scope.fetchFolders = function() {
                $http.get('/api/folders').then(res => {
                    $scope.viewState.folders = res.data;
                    $scope.buildCommands();
                });
            };

            $scope.refreshFeeds = function() {
                $scope.viewState.refreshing = true;
                $http.post('/api/refresh').then(() => {
                    setTimeout(() => {
                        $scope.fetchItems(true);
                        $scope.viewState.refreshing = false;
                        $scope.showToast('All feeds updated', 'success');
                    }, 2000);
                });
            };

            $scope.viewDigest = function() {
                $http.get('/api/digest').then(res => {
                    $scope.digestItems = res.data;
                    $scope.viewState.showDigest = true;
                });
            };

            $scope.setFilter = function(filter) {
                $scope.viewState.filter = filter;
                $scope.fetchItems();
                if (window.innerWidth < 768) $scope.sidebarOpen = false;
            };

            $scope.getTitle = function() {
                if ($scope.viewState.filter === 'all') return 'Inbox';
                if ($scope.viewState.filter === 'bookmarks') return 'Bookmarks';
                if ($scope.viewState.filter.startsWith('folder:')) {
                    const id = parseInt($scope.viewState.filter.split(':')[1]);
                    const f = $scope.viewState.folders.find(x => x.id === id);
                    return f ? f.name : 'Folder';
                }
                return 'Nexus';
            };

            // -- Interaction --
            $scope.openItem = function(item) {
                $scope.activeItem = item;
                $scope.performAction('read', item.id); 
                $scope.renderContent();
            };

            $scope.closeItem = function() { 
                $scope.activeItem = null; 
                window.speechSynthesis.cancel();
                $scope.speaking = false;
            };

            $scope.toggleBookmark = function(item, $event) {
                $event.stopPropagation();
                item.is_bookmarked = !item.is_bookmarked; 
                $scope.performAction('bookmark', item.id);
                $scope.showToast(item.is_bookmarked ? 'Saved to Bookmarks' : 'Removed from Bookmarks', 'success');
            };

            $scope.performAction = function(action, id) {
                if (action === 'read') {
                    $scope.viewState.items.forEach(i => { if(i.id === id) i.is_read = 1; });
                    $http.post(`/api/read/${id}`, {read: 1});
                }
                if (action === 'bookmark') $http.post(`/api/bookmark/${id}`, {});
            };

            $scope.addFeed = function() {
                if(!$scope.newFeed.url) return;
                $http.post('/api/add_feed', $scope.newFeed).then(() => {
                    $scope.showToast('Feed added successfully', 'success');
                    $scope.closeModals();
                    $scope.newFeed.url = '';
                    $scope.fetchFolders();
                    $timeout(() => $scope.fetchItems(true), 1000); 
                });
            };
            
            $scope.addCollection = function() {
                if(!$scope.newCollectionName) return;
                $http.post('/api/folders', {name: $scope.newCollectionName}).then(() => {
                    $scope.showToast('Collection created');
                    $scope.closeModals();
                    $scope.fetchFolders();
                    $scope.newCollectionName = '';
                });
            };
            
            $scope.deleteFolder = function(id, $event) {
                $event.stopPropagation();
                if(confirm('Delete this collection? Feeds will move to General.')) {
                    $http.delete('/api/folders/'+id).then(() => {
                         $scope.fetchFolders();
                         $scope.showToast('Collection deleted');
                    });
                }
            };
            
            $scope.deleteItem = function(id, $event) {
                 $event.stopPropagation();
                 // In a real app, we'd have an endpoint. For now, visually remove.
                 $scope.viewState.items = $scope.viewState.items.filter(i => i.id !== id);
            };

            // -- Robust Bionic Reader & Markdown --
            $scope.cleanSummary = function(html) {
                return $sce.trustAsHtml(DOMPurify.sanitize(html, {ALLOWED_TAGS: []})); 
            };

            $scope.renderContent = function() {
                if (!$scope.activeItem) return;
                let content = $scope.activeItem.content || $scope.activeItem.summary;
                
                // Parse Markdown first
                content = marked.parse(content);
                content = DOMPurify.sanitize(content); 

                if ($scope.config.bionic) {
                    const div = document.createElement('div');
                    div.innerHTML = content;
                    
                    function processNode(node) {
                        if (node.nodeType === 3) { 
                            const words = node.nodeValue.split(/(\s+)/);
                            if (words.length === 1 && words[0].trim() === '') return;
                            const span = document.createElement('span');
                            words.forEach(word => {
                                if (word.trim().length > 0) {
                                    const len = word.length;
                                    if (len === 1) span.innerHTML += `<b class="bionic">${word}</b>`;
                                    else {
                                        const mid = Math.ceil(len / 2);
                                        span.innerHTML += `<b class="bionic">${word.slice(0, mid)}</b>${word.slice(mid)}`;
                                    }
                                } else span.innerHTML += word;
                            });
                            node.replaceWith(span);
                        } else if (node.nodeType === 1 && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                            Array.from(node.childNodes).forEach(processNode);
                        }
                    }
                    Array.from(div.childNodes).forEach(processNode);
                    content = div.innerHTML;
                }
                $scope.renderedContent = $sce.trustAsHtml(content);
            };
            
            // -- Advanced Features --
            $scope.markAllRead = function() {
                $scope.viewState.items.forEach(i => i.is_read = 1);
                // API Call stub
                $scope.showToast('All items marked as read');
            };
            
            $scope.toggleHideRead = function() {
                $scope.config.hideRead = !$scope.config.hideRead;
                $scope.saveSettings();
            };
            
            $scope.surpriseMe = function() {
                const unread = $scope.viewState.items.filter(i => !i.is_read);
                if (unread.length > 0) {
                    const randomItem = unread[Math.floor(Math.random() * unread.length)];
                    $scope.openItem(randomItem);
                } else {
                    $scope.showToast('No unread items to surprise you with!');
                }
            };
            
            $scope.speakArticle = function() {
                if ($scope.speaking) {
                    window.speechSynthesis.cancel();
                    $scope.speaking = false;
                    return;
                }
                const text = new DOMParser().parseFromString($scope.renderedContent.$$unwrapTrustedValue(), 'text/html').body.textContent;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = () => { $scope.$apply(() => $scope.speaking = false); };
                window.speechSynthesis.speak(utterance);
                $scope.speaking = true;
            };
            
            $scope.copyLink = function() {
                // Fallback for non-secure contexts
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText($scope.activeItem.link).then(() => $scope.showToast('Link Copied'));
                } else {
                    let textArea = document.createElement("textarea");
                    textArea.value = $scope.activeItem.link;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        $scope.showToast('Link Copied');
                    } catch (err) {
                        $scope.showToast('Unable to copy', 'error');
                    }
                    document.body.removeChild(textArea);
                }
            };
            
            $scope.shareArticle = function() {
                if (navigator.share) {
                    navigator.share({title: $scope.activeItem.title, url: $scope.activeItem.link}).catch(() => {});
                } else {
                    $scope.copyLink();
                }
            };
            
            $scope.scrollToTop = function() {
                 document.getElementById('reader-scroll').scrollTo({top: 0, behavior: 'smooth'});
            };
            
            // Scroll Progress
            window.updateScrollProgress = function() {
                const el = document.getElementById('reader-scroll');
                if(el) {
                    const scroll = el.scrollTop;
                    const height = el.scrollHeight - el.clientHeight;
                    $scope.$apply(() => $scope.scrollProgress = (scroll / height) * 100);
                }
            };
            
            // Import OPML
            $scope.importOpml = function(element) {
                var fd = new FormData();
                fd.append("file", element.files[0]);
                $http.post("/api/opml/import", fd, {
                    headers: {'Content-Type': undefined},
                    transformRequest: angular.identity
                }).then(() => {
                    $scope.showToast('OPML Imported');
                    $scope.fetchFolders();
                    $scope.fetchItems(true);
                });
            };

             // Import DB
            $scope.importDb = function(element) {
                if(!confirm('This will overwrite your current database. Continue?')) return;
                var fd = new FormData();
                fd.append("file", element.files[0]);
                $http.post("/api/db/import", fd, {
                    headers: {'Content-Type': undefined},
                    transformRequest: angular.identity
                }).then(() => {
                    $scope.showToast('Database Imported. Reloading...');
                    setTimeout(() => window.location.reload(), 1000);
                });
            };

            // -- Command Palette Logic --
            $scope.buildCommands = function() {
                let cmds = [];
                cmds.push({ label: 'Go to Inbox', icon: 'inbox', category: 'Navigation', action: () => $scope.setFilter('all') });
                cmds.push({ label: 'Go to Bookmarks', icon: 'star', category: 'Navigation', action: () => $scope.setFilter('bookmarks') });
                cmds.push({ label: 'Toggle Zen Mode', icon: 'eye', category: 'Settings', action: () => $scope.toggleZenMode(), shortcut: 'Z' });
                cmds.push({ label: 'Toggle Theme', icon: 'sun', category: 'Settings', action: () => { $scope.config.theme = $scope.config.theme === 'dark' ? 'sepia' : 'dark'; $scope.saveSettings(); } });
                
                $scope.viewState.folders.forEach(f => {
                    cmds.push({ label: 'Go to ' + f.name, icon: 'folder', category: 'Folders', action: () => $scope.setFilter('folder:'+f.id) });
                });
                $scope.viewState.items.forEach(i => {
                    cmds.push({ label: i.title, icon: 'check', category: 'Articles', action: () => $scope.openItem(i) });
                });
                $scope.allCommands = cmds;
                $scope.filterCommands();
            };

            $scope.filterCommands = function() {
                const q = ($scope.cmdQuery || '').toLowerCase();
                const filtered = $scope.allCommands.filter(c => c.label.toLowerCase().includes(q));
                const groups = {};
                filtered.forEach(c => {
                    if(!groups[c.category]) groups[c.category] = [];
                    groups[c.category].push(c);
                });
                $scope.filteredCommands = Object.keys(groups).map(k => ({ category: k, items: groups[k] }));
            };
            
            $scope.highlightMatch = function(text) {
                if(!$scope.cmdQuery) return $sce.trustAsHtml(text);
                const regex = new RegExp(`(${$scope.cmdQuery})`, 'gi');
                return $sce.trustAsHtml(text.replace(regex, '<span class="text-indigo-400">$1</span>'));
            };

            // -- UI Helpers --
            $scope.toggleSidebar = () => $scope.sidebarOpen = !$scope.sidebarOpen;
            $scope.toggleZenMode = () => $scope.zenMode = !$scope.zenMode;
            
            $scope.openModal = (name) => {
                $scope.modals[name] = true;
                if(name === 'cmd') { $scope.cmdQuery = ''; $scope.filterCommands(); }
            };
            $scope.closeModals = () => { 
                $scope.modals.add = false; 
                $scope.modals.cmd = false; 
                $scope.modals.settings = false; 
                $scope.modals.addCollection = false; 
            };

            $scope.showToast = function(msg, type='success', title='') {
                const id = Date.now();
                $scope.toasts.push({id, msg, type, title: title || (type==='error'?'Error':'Success')});
                $timeout(() => $scope.toasts = $scope.toasts.filter(t => t.id !== id), 3000);
            };

            $scope.clearCache = function() { $scope.showToast('Cache Cleared', 'success'); };
            $scope.resetDb = function() { 
                if(confirm('Are you sure? This will wipe everything.')) {
                    $http.post('/api/db/reset').then(() => {
                        $scope.showToast('Database Reset', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    });
                }
            };

            Mousetrap.bind(['command+k', 'ctrl+k'], () => $scope.$apply(() => $scope.openModal('cmd')));
            Mousetrap.bind('esc', () => $scope.$apply(() => { $scope.closeModals(); $scope.closeItem(); $scope.viewState.showDigest = false; }));
            Mousetrap.bind('z', () => $scope.$apply(() => $scope.toggleZenMode()));
            Mousetrap.bind('?', () => $scope.$apply(() => $scope.modals.shortcuts = true));
            
            $scope.loadSettings();
            $scope.fetchItems();
            $scope.fetchFolders();
        });
    </script>
</body>
</html>
"""

# --- API Routes ---
@app.route('/')
def index(): return HTML

@app.route('/api/items')
def get_items():
    filter_type = request.args.get('filter', 'all')
    folder = request.args.get('folder')
    conn = get_db()
    query = """
        SELECT i.id, i.feed_id, i.title, i.summary, i.content, i.link, i.published, i.author, i.is_read, i.is_bookmarked, i.read_time_min, i.sentiment, i.tags,
               f.title as feed_title, f.favicon
        FROM items i JOIN feeds f ON i.feed_id = f.id WHERE 1=1 
    """
    params = []
    if folder:
        query += " AND f.folder_id = ?"
        params.append(folder)
    elif filter_type == 'bookmarks': query += " AND i.is_bookmarked = 1"
    elif filter_type == 'all': query += " AND i.is_read = 0"
    query += " ORDER BY i.published DESC LIMIT 100"
    items = conn.execute(query, params).fetchall()
    conn.close()
    return jsonify([dict(i) for i in items])

@app.route('/api/digest')
def get_digest():
    conn = get_db()
    # Fetch setting
    row = conn.execute("SELECT value FROM settings WHERE key='digestWindow'").fetchone()
    days = int(row['value']) if row else 3
    limit_date = datetime.now() - timedelta(days=days)
    query = """
        SELECT i.id, i.title, i.summary, i.link, i.published, f.title as feed_title
        FROM items i JOIN feeds f ON i.feed_id = f.id 
        WHERE i.published > ? ORDER BY i.published DESC LIMIT 20
    """
    items = conn.execute(query, (limit_date,)).fetchall()
    conn.close()
    return jsonify([dict(i) for i in items])

@app.route('/api/folders', methods=['GET', 'POST'])
def get_folders():
    conn = get_db()
    if request.method == 'POST':
         name = request.json.get('name')
         conn.execute("INSERT INTO folders (name) VALUES (?)", (name,))
         conn.commit()
    
    data = conn.execute("SELECT * FROM folders ORDER BY name").fetchall()
    conn.close()
    return jsonify([dict(d) for d in data])

@app.route('/api/folders/<int:id>', methods=['DELETE'])
def delete_folder(id):
    if id in [1, 999]: return jsonify(success=False, error="Cannot delete system folder")
    conn = get_db()
    # Move feeds to General
    conn.execute("UPDATE feeds SET folder_id = 1 WHERE folder_id = ?", (id,))
    conn.execute("DELETE FROM folders WHERE id = ?", (id,))
    conn.commit()
    conn.close()
    return jsonify(success=True)

@app.route('/api/read/<int:id>', methods=['POST'])
def mark_read(id):
    conn = get_db()
    conn.execute("UPDATE items SET is_read=? WHERE id=?", (request.json.get('read', 1), id))
    conn.commit()
    conn.close()
    return jsonify(success=True)

@app.route('/api/bookmark/<int:id>', methods=['POST'])
def toggle_bookmark(id):
    conn = get_db()
    curr = conn.execute("SELECT is_bookmarked FROM items WHERE id=?", (id,)).fetchone()[0]
    conn.execute("UPDATE items SET is_bookmarked=? WHERE id=?", (0 if curr else 1, id))
    conn.commit()
    conn.close()
    return jsonify(success=True)

@app.route('/api/refresh', methods=['POST'])
def refresh_feeds():
    threading.Thread(target=background_worker).start()
    return jsonify(success=True)

@app.route('/api/add_feed', methods=['POST'])
def add_feed():
    data = request.json or request.form
    url = data.get('url')
    folder_id = data.get('folder_id')
    new_folder = data.get('new_folder_name')
    
    if not url: return jsonify(success=False, error="Missing URL")

    conn = get_db()
    if folder_id == 'new' and new_folder:
        cur = conn.execute("INSERT INTO folders (name) VALUES (?)", (new_folder,))
        folder_id = cur.lastrowid

    clean_url, is_yt, is_rd = detect_platform(url)
    try:
        conn.execute("INSERT INTO feeds (folder_id, url, is_youtube, is_reddit, favicon) VALUES (?, ?, ?, ?, ?)",
                    (folder_id, clean_url, is_yt, is_rd, get_favicon(clean_url)))
        conn.commit()
        feed_id = conn.execute("SELECT id FROM feeds WHERE url=?", (clean_url,)).fetchone()[0]
        threading.Thread(target=fetch_feed, args=(feed_id, clean_url)).start()
    except Exception as e:
        print(f"Error adding feed: {e}")
        pass
    finally:
        conn.close()
    return jsonify(success=True)

@app.route('/api/settings', methods=['GET', 'POST'])
def handle_settings():
    conn = get_db()
    if request.method == 'POST':
        for k, v in request.json.items():
            conn.execute("INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)", (k, str(v)))
        conn.commit()
        conn.close()
        return jsonify(success=True)
    else:
        rows = conn.execute("SELECT key, value FROM settings").fetchall()
        conn.close()
        settings = {row['key']: row['value'] for row in rows}
        return jsonify(settings)

@app.route('/api/opml/import', methods=['POST'])
def import_opml():
    f = request.files['file']
    tree = ET.parse(f)
    root = tree.getroot()
    conn = get_db()
    
    # Simple OPML import logic
    for outline in root.findall('.//outline'):
        url = outline.get('xmlUrl')
        if url:
            try:
                conn.execute("INSERT OR IGNORE INTO feeds (folder_id, title, url, favicon) VALUES (1, ?, ?, ?)", 
                             (outline.get('title', 'Unknown'), url, get_favicon(url)))
            except: pass
    conn.commit()
    conn.close()
    threading.Thread(target=background_worker).start()
    return jsonify(success=True)

@app.route('/api/opml/export', methods=['GET'])
def export_opml():
    conn = get_db()
    feeds = conn.execute("SELECT * FROM feeds").fetchall()
    conn.close()
    
    opml = '<?xml version="1.0" encoding="UTF-8"?><opml version="1.0"><head><title>Nexus Feeds</title></head><body>'
    for f in feeds:
        opml += f'<outline text="{f["title"]}" title="{f["title"]}" type="rss" xmlUrl="{f["url"]}" htmlUrl="{f["site_url"]}"/>'
    opml += '</body></opml>'
    
    from flask import Response
    return Response(opml, mimetype='text/xml', headers={"Content-Disposition": "attachment;filename=nexus_feeds.opml"})

@app.route('/api/backup', methods=['GET'])
def download_backup():
    return send_file(DB_FILE, as_attachment=True)

@app.route('/api/db/reset', methods=['POST'])
def reset_db():
    if os.path.exists(DB_FILE):
        os.remove(DB_FILE)
    init_db()
    return jsonify(success=True)

@app.route('/api/db/import', methods=['POST'])
def import_db():
    f = request.files['file']
    f.save(DB_FILE)
    return jsonify(success=True)

if __name__ == '__main__':
    if not os.path.exists(DB_FILE): init_db()
    
    # Try to bind to port 5000, print friendly error if fail
    try:
        print("âœ… Nexus Server Running on http://0.0.0.0:5000")
        app.run(host='0.0.0.0', port=PORT, debug=False)
    except OSError:
        print(f"âŒ Error: Port {PORT} is already in use. Stop the other process first.")
        sys.exit(1)
